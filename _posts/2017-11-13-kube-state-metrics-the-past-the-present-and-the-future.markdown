---
layout: post
title: kube-state-metrics the past, the present, and the future
archived: false
---

The [kube-state-metrics](https://github.com/kubernetes/kube-state-metrics) project is a service you can deploy in your [Kubernetes](https://kubernetes.io/) cluster. It watches Kubernetes objects, in order to expose metrics in the [Prometheus](https://prometheus.io/) format. The project lives under the umbrella of the Kubernetes organization and was started by [Sam Ghods](https://twitter.com/theghodss) at Box in May 2016. There has been a growing popularity in the project, so I wanted to share the current state of the project and what I believe the future holds. This post will particularly focus on the architectural changes that the project has undergone and explain the reasoning for the more significant ones.

Let’s start by highlighting the architecture of the project in the beginning. The way kube-state-metrics was designed to work was by building an in-memory cache of the Kubernetes objects: deployments, nodes, and pods. The in-memory cache was created using the informer framework, which is widely used within Kubernetes. An informer started by listing all available objects and then listened for events on those resources: add, update, delete. Using these events, a best effort in-memory representation was created. Network partitions or other failures can cause events to not be received by a listening informer. The cache was regularly re-created, to ensure that at least every "resync interval" the cache content is consistent with the state in etcd.

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="638px" version="1.1" viewBox="0 0 638 96" style="max-width:100%;max-height:96px;display:block;margin:auto;"><defs/><g transform="translate(0.5,0.5)"><rect x="67" y="17" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(109.5,40.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="35" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Cache</div></div></foreignObject><text x="18" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Cache</text></switch></g><path d="M 7 47 L 60.63 47" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 65.88 47 L 58.88 50.5 L 60.63 47 L 58.88 43.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(7.5,31.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="39" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Update</div></div></foreignObject><text x="20" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Update</text></switch></g><path d="M 7 66 L 60.63 66" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 65.88 66 L 58.88 69.5 L 60.63 66 L 58.88 62.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(7.5,51.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="35" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Delete</div></div></foreignObject><text x="18" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Delete</text></switch></g><path d="M 7 26 L 60.63 26" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 65.88 26 L 58.88 29.5 L 60.63 26 L 58.88 22.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(8.5,11.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="22" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Add</div></div></foreignObject><text x="11" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Add</text></switch></g><rect x="287" y="17" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(324.5,33.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="44" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 45px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Metrics<div>Registry</div></div></div></foreignObject><text x="22" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 187 62 L 228.06 82.53 Q 237 87 245.94 82.53 L 281.3 64.85" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 286 62.5 L 281.3 68.76 L 281.3 64.85 L 278.17 62.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 287 32 L 245.94 11.47 Q 237 7 228.06 11.47 L 192.7 29.15" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 188 31.5 L 192.7 25.24 L 192.7 29.15 L 195.83 31.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(209.5,33.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="55" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 56px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Sync<div>every 10 s</div></div></div></foreignObject><text x="28" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="517" y="17" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(544.5,40.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="65" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 66px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Prometheus</div></div></foreignObject><text x="33" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Prometheus</text></switch></g><path d="M 517 47 L 413.37 47" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 408.12 47 L 415.12 43.5 L 413.37 47 L 415.12 50.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(427.5,18.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="80" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Request every<div>scrape interval</div></div></div></foreignObject><text x="40" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></g></svg>

The problem was, that kube-state-metrics iterated over the objects in a ten second interval and created metrics off of all objects in the cache. If a metric already existed, it was updated. For example the `container_restarts` metric is created per container in a cluster, however, metrics won't disappear from the metrics registry, meaning the number of metrics and therefore the memory usage of kube-state-metrics will infinitely grow with the lifetime of a Kubernetes cluster. Additionally, this conflicts with Prometheus’ staleness requirements, as it continues to expose the metrics even after the deletion of an object and the information can be up to 10 seconds old.

Around half a year later my colleague Fabian Reinartz and I picked up its development. After continued engagement and development of the architecture as well as features we became the maintainers of the project. We were aware of the limitations of the existing implementation and decided to adjust the architecture to work similarly to many of the exporters within the Prometheus ecosystem. Rather than populating the metrics every ten seconds, the metrics are created on-demand, whenever Prometheus requests the `/metrics` endpoint. This most importantly fixed the above mentioned problems, but also opened the architecture up to be more modular. Every type of object has its own collector that is registered onto a Prometheus metrics registry, and each of those collectors live in a separate file.

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="659px" version="1.1" viewBox="0 0 659 69" style="max-width:100%;max-height:69px;display:block;margin:auto;"><defs/><g transform="translate(0.5,0.5)"><rect x="68" y="6" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(110.5,29.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="35" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Cache</div></div></foreignObject><text x="18" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Cache</text></switch></g><path d="M 8 36 L 61.63 36" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 66.88 36 L 59.88 39.5 L 61.63 36 L 59.88 32.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 8 55 L 61.63 55" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 66.88 55 L 59.88 58.5 L 61.63 55 L 59.88 51.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 8 16 L 61.63 16" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 66.88 16 L 59.88 19.5 L 61.63 16 L 59.88 12.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(9.5,3.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="21" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 22px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div style="text-align: left"><span>Add</span></div></div></div></foreignObject><text x="11" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><g transform="translate(7.5,21.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="39" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 40px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div style="text-align: left"><span>Update</span></div></div></div></foreignObject><text x="20" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><g transform="translate(7.5,41.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="35" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div style="text-align: left"><span>Delete</span></div></div></div></foreignObject><text x="18" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="308" y="6" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(345.5,22.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="44" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 45px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Metrics<div>Registry</div></div></div></foreignObject><text x="22" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 308 36 L 194.37 36" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 189.12 36 L 196.12 32.5 L 194.37 36 L 196.12 39.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(202.5,7.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="96" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Build metrics from<div>cache on demand</div></div></div></foreignObject><text x="48" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="538" y="8" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(565.5,31.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="65" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 66px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Prometheus</div></div></foreignObject><text x="33" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Prometheus</text></switch></g><path d="M 538 38 L 434.37 37.06" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 429.12 37.01 L 436.15 33.57 L 434.37 37.06 L 436.09 40.57 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(443.5,8.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="78" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Request every<div>scrape interval</div></div></div></foreignObject><text x="39" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></g></svg>

Because of this work the structure of the project was simplified, and therefore was opened up for new contributions. Surprisingly, kube-state-metrics ended up getting a lot more attention than we thought. Initially we were just scratching our own itch, and today the project has:

* 349 stars on GitHub
* 47 total contributors
* 351 commits
* 114 metrics (7 CronJob, 6 DaemonSet, 11 Deployments, 5 HPA, 12 Job, 2 LimitRange, 3 Namespace, 14 Node, 3 PVC, 22 Pod, 7 ReplicaSet, 8 ReplicationController, 2 ResourceQuota, 3 Service, 9 StatefulSet)

The project has grown organically, Fabian and I only put in an initial effort and made it approachable for contributions and the majority of these metrics were not developed by the maintainers, but through a lot of community contributions. For comparison, initially the project exposed four metrics, whereas after many contributions it is now at 114 metrics. Most of what we have worked on revolve around ensuring that the architecture of kube-state-metrics will continue to scale and enable contributions.

In early 2017, Kubernetes sig-instrumentation decided that kube-state-metrics has become an important enough component that we would like to create more formal compatibility guarantees and more importantly scalability guarantees, and so thanks to a couple of Google employees some scalability tests were executed on 100, 500, and 1000 node clusters. The exact [findings are documented in a Google doc](https://docs.google.com/document/d/1hm5XrM9dYYY085yOnmMDXu074E4RxjM7R5FS4-WOflo/edit?usp=sharing), but in short it exceeded all of our expectations and scaled a lot better than we had expected. After a couple rounds of refinements, ensuring that the metrics are consistent and in a good shape (although we know today that we missed multiple) we were comfortable with [releasing 1.0 of kube-state-metrics](https://github.com/kubernetes/kube-state-metrics/releases/tag/v1.0.0) in August 2017.

Since then the project got even more contributions and an additional maintainer has joined the team: [@andyxning](https://github.com/andyxning). I want to give him a huge shout out as he has been a very active part of the project and continuously improves and maintains it.

We have recently released version 1.1.0 of kube-state-metrics and have also hit some new scalability concerns. In extremely high churn environments, meaning when Pods quickly appear and disappear, particularly when _a lot_ of Kubernetes `Job`s are run, it inevitably puts heavy load on Prometheus itself as well as the exporter exporting these metrics. While Prometheus 2.0 aims to solve this on the Prometheus time-series database side, kube-state-metrics still has plenty of optimization opportunities.

While the amount of metrics is going to grow further in the future, there are two primary factors, which can be optimized in regards to the architecture of kube-state-metrics: the size of the in memory state it needs to keep, as well as the effort it needs to go through, in order to present the metrics output to Prometheus when requested.

The memory consumption cannot be lowered, by an order of magnitude, as kube-state-metrics will always need to keep the current metric values in memory, therefore the memory consumption cannot be lower than `O(n)`.

Today, kube-state-metrics needs to iterate through the objects stored in cache, whenever Prometheus requests the `/metrics` endpoint. The has still has potential for optimization. Currently, when Prometheus requests the metrics endpoint, kube-state-metrics needs to iterate over all objects and create the metrics off of those. The question is, why does the intermediate step have to be taken to cache the objects intermediately only to then on-demand generate the metrics. The metrics could just as well be populated directly. In that case a property of the first architecture would return, however, where metrics can never be unregistered. Since the cache is being replaced with a metrics registry in this architecture, we can perform the same strategy of keeping the registry consistent as it is currently done with the cache. When an object is deleted, the metrics associated with it are unregistered, and to ensure that at least in a given interval the registry is consistent, it is regularly re-created and populated from a clean start.

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="419px" version="1.1" viewBox="0 0 419 67" style="max-width:100%;max-height:67px;display:block;margin:auto;"><defs/><g transform="translate(0.5,0.5)"><rect x="68" y="6" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(105.5,22.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="44" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 45px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Metrics<div>Registry</div></div></div></foreignObject><text x="22" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 8 36 L 61.63 36" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 66.88 36 L 59.88 39.5 L 61.63 36 L 59.88 32.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 8 55 L 61.63 55" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 66.88 55 L 59.88 58.5 L 61.63 55 L 59.88 51.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 8 16 L 61.63 16" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 66.88 16 L 59.88 19.5 L 61.63 16 L 59.88 12.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(9.5,3.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="21" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 22px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div style="text-align: left"><span>Add</span></div></div></div></foreignObject><text x="11" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><g transform="translate(7.5,21.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="39" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 40px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div style="text-align: left"><span>Update</span></div></div></div></foreignObject><text x="20" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><g transform="translate(7.5,41.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="35" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div style="text-align: left"><span>Delete</span></div></div></div></foreignObject><text x="18" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><rect x="298" y="6" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(325.5,29.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="65" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 66px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Prometheus</div></div></foreignObject><text x="33" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Prometheus</text></switch></g><path d="M 298 36 L 194.37 36" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 189.12 36 L 196.12 32.5 L 194.37 36 L 196.12 39.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(204.5,7.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="78" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">Request every<div>scrape interval</div></div></div></foreignObject><text x="39" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></g></svg>

Clayton Coleman has lead some discussions to go into this direction and provided useful input as to how Red Hat has solved scalability issues in OpenShift similar to how they are present in kube-state-metrics today. The architecture was definitely not my idea, I merely contributed my knowledge about the Prometheus ecosystem and the architecture as described above is a result of a number of discussions. I just happen to have decided to document it here.

As you have probably gathered, the project has come a long way, however, the next steps will affect large portions of the code base. This is necessesary to solve the existing scalability issues and will allow it to continue to scale as expected in the future for large Kubernetes clusters.
